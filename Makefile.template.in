#
#  SnapFind
#  An interactive image search application
#  Version 1
#
#  Copyright (c) 2002-2005 Intel Corporation
#  Copyright (c) 2006 Larry Huston <larry@thehustons.net>
#  All Rights Reserved.
#
#  This software is distributed under the terms of the Eclipse Public
#  License, Version 1.0 which can be found in the file named LICENSE.
#  ANY USE, REPRODUCTION OR DISTRIBUTION OF THIS SOFTWARE CONSTITUTES
#  RECIPIENT'S ACCEPTANCE OF THIS AGREEMENT
#

#
# Where the headers, libraries, and binaries should be placed during
# the build process.
#
BUILDROOT = @BUILDROOT@
BUILD_LIB_PATH = $(BUILDROOT)/lib

#  Install the directories
INSTALLBASE=/usr/local/diamond
INSTALLDIR_LIB=${INSTALLBASE}/lib

CPPFLAGS += @CPPFLAGS@
CPPFLAGS += -I@abs_top_srcdir@/include -I. -I${SRCDIR} -m32

# from the configure script
CFLAGS += @CFLAGS@ @OPENDIAMOND_CFLAGS@


# include the shared source files
VPATH += $(SRCDIR)
vpath %.h $(VPATH)

LDFLAGS += @LDFLAGS@
LDFLAGS += -L${BUILD_LIB_PATH} -m32

#Just to go overboard and be sure
CFLAGS += -D_GNU_SOURCE
CFLAGS += -D_THREAD_SAFE
CFLAGS += -D_REENTRANT
# general flags
CFLAGS += -O2
CFLAGS += -ggdb
CFLAGS += -DDEBUG
CFLAGS += -Wall
CFLAGS += -fPIC
CFLAGS += -ffast-math
CFLAGS += -fdata-sections -ffunction-sections -fvisibility=hidden

EXTRA_CFLAGS += -Werror-implicit-function-declaration


# The tools we want to use to compile
CC = @CC@
CPLUSPLUS = @CXX@
DIAMOND_BUNDLE_SEARCH = @DIAMOND_BUNDLE_SEARCH@


INSTALL = install
MKDIR = mkdir

#
# Other misc objects to remove during a make clean operation.
# For now we remove profiling object (gmon.out) and any core
# files that have been generated.
#

CLEAN_OTHERS += gmon.out core.* *.core

#
# Objects to remove during "distclean".  For now just the .depend
#
DIST_OBJS += .depend Makefile 

%.o: %.cc
	${CPLUSPLUS} ${CPPFLAGS} ${CFLAGS} -c $< -o $@

%.o: %.c
	${CC} ${CPPFLAGS} ${CFLAGS} ${EXTRA_CFLAGS} -c $< -o $@

%.a: $(LIBOBJS)
	rm -f $@ 
	ar -csr $@  $^
	cp -f $@ ${BUILD_LIB_PATH}

FIL_COMMAND=$(CPLUSPLUS) -o $@ $^ $(LDFLAGS) $(STATIC_LIBS) $(LDPATH) $(FILTER_LIBS) -Wl,--gc-sections @OPENDIAMOND_LIBS@
BUNDLE_COMMAND=$(DIAMOND_BUNDLE_SEARCH) -o $@ $^

# The common targets

.PHONY :  all depend clean installdirs install

#
#  Define a do-subdirs function to execute recursive targets such as "all"
#  and clean. It calls "make" on each of the directories listed in SUBDIRS
#
ifndef do-subdirs
define do-subdirs
	@for entry in ${SUBDIRS}; do \
		set -e; \
		if test -d $${entry}; then \
			${MAKE} -C $${entry} $@; \
		else \
			echo "*** Warning:  couldn't find subdir $${entry}"; \
		fi; \
	done
endef
endif



TARGETS += copylib

#
#  Rebuild everything.
#
all: ${SRCS} ${TARGETS} ${SUBDIRS}
	${do-subdirs}


#
# Make the dependencies for this directory and its children
#
depend: 
ifneq ($(strip ${SRCS}),)
	${CC} -E -M ${CPPFLAGS} ${CFLAGS} ${SRCS} > .depend
endif
	${do-subdirs}	


#
# Clean up the objects and binary in this directory and its children
#
clean: 
ifneq ($(strip ${OBJS} ${CLEAN_OTHERS} $(TARGETS)),)
	${RM} ${OBJS} $(TARGETS) $(CLEAN_OTHERS)
endif
	${do-subdirs}


#
# Clean up the objects and binary in this directory and its children
#
distclean: 
ifneq ($(strip ${OBJS} $(CLEAN_OTHERS) $(TARGETS) $(DIST_OBJS)),)
	${RM} ${OBJS} $(TARGETS} $(CLEAN_OTHERS) $(DIST_OBJS)
endif
	${do-subdirs}

copylib:
	@for entry in ${SHARED_LIB} ; do \
		cp -fuv $${entry} ${BUILD_LIB_PATH}; \
	done




# Installs must get done as root, but we don't need to test here since 
# installdirs will do it.  Note that local Makefiles should also perform
# this check iff they define their own installdirs target.

install: installdirs
ifneq ($(strip ${INSTALL_LIBS}),)	
	@for entry in ${INSTALL_LIBS} ; do \
		${INSTALL} $${entry} ${INSTALLDIR_LIB} ; \
	done
endif
	${do-subdirs}



#  Create the directories to install into

ALL_INSTALLDIRS= ${INSTALLBASE} ${INSTALLDIR_LIB}
installdirs:
	${TESTROOT}
	@for entry in ${ALL_INSTALLDIRS} ; do \
		if ! test -d $${entry}; then \
			echo Creating directory $${entry} ; \
			${MKDIR} $${entry} ; \
		fi; \
	done
	${do-subdirs}



#
# Inlude the dependancies that were included earlier.
-include .depend

