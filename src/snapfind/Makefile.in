#
#       SnapFind (Release 0.9)
#       An interactive image search application
#
#      Copyright (c) 2002-2005, Intel Corporation
#      All Rights Reserved
#
#  This software is distributed under the terms of the Eclipse Public
#  License, Version 1.0 which can be found in the file named LICENSE.
#  ANY USE, REPRODUCTION OR DISTRIBUTION OF THIS SOFTWARE CONSTITUTES
#  RECIPIENT'S ACCEPTANCE OF THIS AGREEMENT
#

ROOTDIR = @top_srcdir@
VPATH = @srcdir@
SDIR = @srcdir@
OBJROOT = @OBJROOT@


# 
# Set the include paths.  
# XXX configure should set ...
INCDIR += -I/usr/local/include/opencv
INCDIR += `pkg-config gtk+-2.0 gthread-2.0 --cflags-only-I` 


# 
# Set the libraries and the library paths we will need
# to build these files.
LIBS += -ldl -lfl -lpthread -lm 
LIBS += -Wl,-whole-archive -lsearchlet -lfilterexec -lfilter -llog 
LIBS += -Wl,-no-whole-archive -lfl -lodisk -ltools
LIBS += -lhstub -ldctl -ldconfig
LIBS += -lopencv   -lcvaux -llog -lssl

include $(ROOTDIR)/shared_source/common/Makefile.template

# objects used to build the searchlet(s)
SEARCHLET_SRCS = $(COMMON_SEARCHLET_SRCS) $(COMMON_SHARED_SRCS)
SEARCHLET_SRCS += fil_regex.c
SEARCHLET_SRCS += fil_data2cv.c 
SEARCHLET_SRCS += fil_synth.c  

SEARCHLET_OBJS = $(COMMON_SEARCHLET_OBJS) $(COMMON_SHARED_OBJS)
SEARCHLET_OBJS += fil_regex.o fil_data2cv.o 
SEARCHLET_OBJS += fil_synth.o 

SEARCHLET_LIBS += -lm -Wl,-static -lcvaux -lopencv

SEARCHLET_LIBDIR += 

# objects needed to build the main
SNAPFIND_SRCS = $(COMMON_APP_SRCS) $(COMMON_SHARED_SRCS)
SNAPFIND_SRCS += snapfind.cc sfind_search.cc
SNAPFIND_SRCS +=  read_config.cc  stats_win.c
SNAPFIND_SRCS += progress_win.cc rgb.c   
SNAPFIND_SRCS += snap_popup.cc graph_win.cc cache_control.cc
SNAPFIND_SRCS += sfind_tools.c 

SNAPFIND_OBJS = $(COMMON_APP_OBJS) $(COMMON_SHARED_OBJS)
SNAPFIND_OBJS += snapfind.o sfind_search.o read_config.o 
SNAPFIND_OBJS += progress_win.o snap_popup.o  stats_win.o
SNAPFIND_OBJS += fil_histo.o graph_win.o cache_control.o
SNAPFIND_OBJS += sfind_tools.o

DEBUG_SRCS = face.c
DEBUG_OBJS = face.o

#
# All the source files that are needed for depend.
#
SRCS = $(SNAPFIND_SRCS) $(SEARCHLET_SRCS) $(DEBUG_SRCS)
OBJS = $(SNAPFIND_OBJS) $(SEARCHLET_OBJS) $(DEBUG_OBJS)

#
# Compilation Targets
#


#
# Other objects to cleanup
CLEAN_OTHERS += read_config.cc $(COMMON_SRCS)

TARGETS = $(COMMON_HEADERS) snapfind snap_searchlet.so

include ${ROOTDIR}/Makefile.template

# XXX
# turns on unsafe fp optimizations; we don't require strict IEEE
CFLAGS += -ffast-math -malign-double

ifeq ($(OSTYPE),linux)
DYNAMIC = -rdynamic
endif

ifeq ($(OSTYPE),darwin)
DYNAMIC = -dynamic
endif

cln:
	$(RM) core.*
	$(RM) /tmp/fspec* /tmp/filsp* /tmp/objfil*
	$(RM) /var/tmp/fspec* /var/tmp/filsp* /var/tmp/objfil*

clean-targets:	clean-experiments
	$(RM) $(TARGETS)

default: $(TARGETS)

snap_searchlet.so: $(SEARCHLET_OBJS)
	$(CPLUSPLUS) $(CFLAGS_SO) -o $@ -shared -static $(SEARCHLET_OBJS) $(SEARCHLET_LIBS) $(SEARCHLET_LIBDIR)

libssearch.a: $(SEARCHLET_OBJS)
	$(AR) r $@ $(SEARCHLET_OBJS)

snapfind: $(SNAPFIND_OBJS)
	$(CPLUSPLUS) $(CFLAGS) $(DYNAMIC) -o $@ $(SNAPFIND_OBJS) $(LIBS) $(LIBDIR) `pkg-config gtk+-2.0 gthread-2.0 --cflags --libs`

search:	search.c
	$(CC) $(CFLAGS) $(DYNAMIC) -o $@ $< $(LIBDIR) `pkg-config gtk+-2.0 gthread-2.0 --cflags --libs`

profile: profile.o $(SEARCHLET_OBJS)
	$(CC) $(CFLAGS) -o profile profile.o $(SEARCHLET_OBJS) $(LIBS) $(LIBDIR) -lfilterexec -ltools -lodisk

foo: foo.o rgb_histo_search.o snap_search.o window_search.o example_search.o
	$(CC) $(CFLAGS) -o foo foo.o rgb_histo_search.o snap_search.o window_search.o example_search.o

histo_bench: histo_bench.o $(SEARCHLET_OBJS)
	$(CPLUSPLUS) $(CFLAGS) $(DYNAMIC) -rdynamic -o histo_bench histo_bench.o $(SEARCHLET_OBJS) $(LIBS)  $(LIBDIR) 



face_benchmark: face_benchmark.o $(SEARCHLET_OBJS)
	$(CPLUSPLUS) $(CFLAGS) $(DYNAMIC) -rdynamic -o face_benchmark face_benchmark.o $(SEARCHLET_OBJS) $(LIBS)  $(LIBDIR) 

experiment_%: experiment_%.o $(SEARCHLET_OBJS)
	$(CC) $(CFLAGS) -o $@ $< \
  -static $(SEARCHLET_OBJS)  $(LIBS) $(LIBDIR) -lpthread -ldl -lm -Wl,-static -lopencv  

#	$(CC) $(CFLAGS) -o $@ $< $(SEARCHLET_OBJS) $(LIBS) $(LIBDIR) -lfilterexec -ltools -lodisk

EXPERIMENT_OBJS := $(wildcard experiment_*.o)
EXPERIMENT_TGTS = $(EXPERIMENT_OBJS:%.o=%)

experiments:	$(EXPERIMENT_TGTS)

clean-experiments:
	$(RM) $(EXPERIMENT_TGTS)



%.eps:	%.gviz
	dot $< -Gsize="8,10" -Tps -o$@

deps.gviz::
	cp /dev/null $@
	./hviz 5 $(SRCS) >> $@

wavelet-test:	wavelet.o rgb.o
	$(CC) $(CFLAGS) -o wavelet-test wavelet.o rgb.o -static -lwvlt -lm
